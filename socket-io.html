<link rel="import" href="../polymer/polymer.html">
<script src="..//socket.io-client/dist/socket.io.js"></script>


<!--
Socket.io Element.

##### Example

    <socket-io></socket-io>

@element socket-io
@blurb Web component for socket-io interactions
@status alpha
@homepage http://kaosat-dev.github.io/socket-io

TODO: should we expose some event so parsing the "inMessage" is optional (for more complex cases)?
-->
<polymer-element name="socket-io" attributes="socketUrl autoConnect listenTo connected outEventName inMessage outMessage">
  <script>
    Polymer("socket-io", {
      socketUrl:document.location.hostname,
      autoConnect: false,
      connected: false,
      outEventName:"message", 
      outMessage:null,           
      inMessage:null,
      listenTo: [],
      
      enteredView:function(){
		    window.onbeforeunload = this.beforeUnload.bind(this);
        this.init();
        if(this.autoConnect) this.connect();
	    },
      init:function()
      {
        if(window.io == undefined) throw new Error("Could not import socket.io library");
        this.ws = io.connect(this.socketUrl,{'auto connect': false });
        this.ws.on('connect', this.onConnect.bind(this) );
	      this.ws.on('disconnect', this.onDisconnect.bind(this) );
        this.ws.on('error', this.onError.bind(this) );
	      this.ws.on('connect_failed', this.onError.bind(this) );
      },
      //public api
      emit: function(event, data)
	    {
			  console.log("sending '"+event+ "'via polymer-socket-io: data",data);
			  try
			  {
				  if(this.ws) this.ws.emit(event, data);
			  }catch(error)
			  {
				  console.log("cannot send message: error:"+error);
			  }
      },
	    connect:function()
	    {
		    this.disconnect();
        this.ws.socket.connect()
	    },
	    disconnect:function()
	    {
		    if (this.ws != undefined && !this.connected)
		    {
          try{
            this.ws.disconnect();}
          catch(error){
            this.onError(error);
          }
        }
	    },
      //change handlers
      connectedChanged: function(oldValue)
      {
        console.log("connectedChanged",oldValue,"->",this.connected);
        if(!oldValue && this.connected)
        {
          this.connect();
        }
        else{ this.disconnect();}
      },
      outMessageChanged: function()
		  {
        if(this.outMessage)
        {
          var fullMessage = this.outMessage;
          var eventName = this.outEventName;
          if( this.outMessage instanceof Object )
          {
            if("event" in fullMessage)
            {
              eventName = fullMessage.event;
              fullMessage = fullMessage.data;
            }
          }  
          this.emit(eventName, fullMessage);
        }
      },
      socketUrlChanged: function() {
        if(this.connected ) this.connect();
      },
      listenToChanged: function(oldListenTo)
      {
        //console.log("listenToList changed",this.listenTo,this.connected,this.ws);
        if(this.ws != undefined)
        {
          if(oldListenTo)
          {
            for(var i=0;i<oldListenTo.length;i++)
            {
              var messageName = oldListenTo[i];
              this.ws.removeAllListeners(messageName)
            } 
          }
          for(var i=0;i<this.listenTo.length;i++)
          {
            var messageName = this.listenTo[i];
            this.ws.on(messageName, this.onMessageRecieved.bind(this, messageName)) 
          }
        }
      },
      //event handlers
      onConnect:function(event){
        console.log("polymer-socket-io connected")
        this.connected = true;
      },
      onDisconnect:function(event){
        console.log("polymer-socket-io disconnected")
        this.connected = false;
      },
      onError:function (error)
	    {
		    console.log('Error in polymer-socket-io',error);
      },
      onMessageRecieved:function(event,msg)
      { 
        console.log("recieved event",event, msg)
        this.inMessage = {event:event,data:msg};
      },
	    beforeUnload: function(event) {
		    this.disconnect();
        this.ws.removeAllListeners('connect');
        this.ws.removeAllListeners('disconnect');
	      this.ws.removeAllListeners('error');
	      this.ws.removeAllListeners('connect_failed');
        for(var i=0;i<this.listenTo.length;i++)
        {
          var messageName = this.listenTo[i];
          this.ws.removeAllListeners(messageName)
        } 
        this.ws = null;
      }
    });
    </script>
</polymer-element>
